#!/bin/sh

echo "Booting Kraken OS..."
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -t devtmpfs dev /dev

# --------------------------------------------------
# NEW: Mount ISO Device to Access root.sfs
# --------------------------------------------------
echo "Mounting ISO device..."
ISO_DEVICE="/dev/sr0"  # CD/DVD drive (common for ISOLINUX)
# Alternative for USB: /dev/disk/by-label/KRAKEN_OS

# Create mount points
mkdir -p /mnt/iso
mkdir -p /mnt/live

# Mount ISO filesystem
mount -t iso9660 -o ro $ISO_DEVICE /mnt/iso

# --------------------------------------------------
# MODIFIED: Mount root.sfs from ISO
# --------------------------------------------------
echo "Mounting SquashFS root filesystem..."
mount -t squashfs -o loop /mnt/iso/root.sfs /mnt/live  # CHANGED PATH

# --------------------------------------------------
# NEW: Handle "ram" Parameter (Copy to Memory)
# --------------------------------------------------
for x in $(cat /proc/cmdline); do
    case $x in
        ram)
            echo "RAM Mode: Copying rootfs to memory..."
            mkdir -p /mnt/ram
            mount -t tmpfs tmpfs /mnt/ram
            cp -a /mnt/live/* /mnt/ram/
            umount /mnt/live
            mount -t squashfs -o loop /mnt/ram /mnt/live  # Mount from RAM
            ;;
    esac
done

# --------------------------------------------------
# Existing Overlay Setup
# --------------------------------------------------
mkdir -p /mnt/cow /mnt/overlay
mount -t tmpfs -o size=512M tmpfs /mnt/cow
mkdir -p /mnt/overlay/upper /mnt/overlay/work

mount -t overlay overlay \
    -o lowerdir=/mnt/live,upperdir=/mnt/overlay/upper,workdir=/mnt/overlay/work \
    /mnt/rootfs

# --------------------------------------------------
# NEW: Cleanup ISO Mount Before Switch
# --------------------------------------------------
umount /mnt/iso  # Important for CD/DVD drives

echo "Switching root filesystem..."
cd /mnt/rootfs
mkdir -p /mnt/rootfs/proc /mnt/rootfs/sys /mnt/rootfs/dev
mount --move /proc /mnt/rootfs/proc
mount --move /sys /mnt/rootfs/sys
mount --move /dev /mnt/rootfs/dev

exec switch_root /mnt/rootfs /sbin/init
